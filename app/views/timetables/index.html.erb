<body class="timetable-page">
  <div class="timetables">

    <header class="timetable-header">
      <div class="header-top">
        <h2>時間割</h2>

        <!-- ログイン状態の表示 -->
        <div class="login-role-label <%= session[:role] %>">
          

          <% if session[:role] == "teacher" %>
            教員としてログイン中
          <% else %>
            生徒としてログイン中
          <% end %>
          <%= image_tag "icon.svg", class: "login-icon" %>
        </div>


      </div>

<%
=begin%>
  @week_offset をコントローラーから渡して、リンクの進行方向を制限
disabled オプションを付けるとクリック不可になります 
<%
=end%>

      <div class="grade-switch">
        <%= link_to "1年", timetables_path(week_offset: params[:week_offset], grade: 1), class: (@grade == 1 ? "active" : "") %>
        <%= link_to "2年", timetables_path(week_offset: params[:week_offset], grade: 2), class: (@grade == 2 ? "active" : "") %>
      </div>

      <div class="grade-underline" style="transform: translateX(<%= @grade == 1 ? "0%" : "100%" %>);"></div>
    </header>

    <div class="schedule">
      <div class="controls">

        <%# --- 左矢印（先週のときは中身を空にして幅だけ確保） --- %>
        <span class="arrow left">
          <% if @week_offset > -1 %>
            <%= link_to "＜", timetables_path(week_offset: @week_offset - 1, grade: @grade) %>
          <% end %>
        </span>

        <%# --- 中央のテキスト --- %>
        <% week_label =
            case @week_offset
            when -1 then "先週"
            when 0  then "今週"
            when 1  then "来週"
            end
        %>
        <span class="current-week"><%= week_label %></span>

        <%# --- 右矢印 --- %>
        <span class="arrow right">
          <% if @week_offset < 1 %>
            <%= link_to "＞", timetables_path(week_offset: @week_offset + 1, grade: @grade) %>
          <% end %>
        </span>

      </div>

      <table class="timetable">
        <thead>
          <tr>
            <% (0..4).each do |i| %>
              <% date = @week_start + i.days %>
              <th><%= date.strftime("%-m月%-d日") %></th>
            <% end %>
          </tr>
          <tr>
            <% %w(月 火 水 木 金).each do |day| %>
              <th><%= day %></th>
            <% end %>
          </tr>
        </thead>

        <tbody>
          <% (1..3).each do |period| %>
            <tr>
              <% (1..5).each do |day| %>
                <% timetable = @timetables.find { |t| t.day_of_week == day && t.period == period } %>
                <% 
                  cell_class = []
                  cell_class << "changed-cell" if timetable && !timetable.base_subject
                  cell_class << "exam-cell" if timetable&.subject&.name&.start_with?("【試験】")
                %>
                <td class="<%= cell_class.join(' ') %>" data-day="<%= day %>" data-period="<%= period %>">
                  <%= timetable&.subject&.name&.gsub("【試験】", "") || "-" %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# --- フッター --- %>
    <footer class="timetable-footer">
      <div class="footer-left">
        <% if session[:role] == "teacher" %>
          <%= link_to "編集", "#", class: "footer-edit-btn", data: { grade: @grade } %>
        <% end %>
      </div>

      <div class="footer-center">
        © 2025 Timetable App
      </div>
    </footer>

</div>

  <!-- 編集用モーダル -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- 科目選択モーダル -->
  <div id="subject-modal" class="modal">
    <div class="modal-content subject-modal-content">
      <span class="close subject-close">&times;</span>
      <h3>科目を選択</h3>
      <div id="subject-modal-body"></div>
    </div>
  </div>

</body>
