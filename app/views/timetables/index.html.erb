<body class="timetable-page">
  <div class="timetables">

    <header class="timetable-header">
      <div class="header-top">
        <h2>時間割</h2>

        <div style="display: flex; align-items: center; gap: 1rem;">
          <!-- メッセージアイコン -->
          <div class="message-icon-container" id="message-icon">
            <svg class="message-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            </svg>
            <span class="unread-badge" id="unread-badge" style="display: none;">0</span>
          </div>

          <!-- ログイン状態の表示 -->
          <div class="login-role-label <%= session[:role] %>">
            <% if session[:role] == "teacher" %>
              教員としてログイン中
            <% else %>
              生徒としてログイン中
            <% end %>
            <%= image_tag "icon.svg", class: "login-icon" %>
          </div>
        </div>
      </div>

      <div class="grade-switch">
        <%= link_to "1年", timetables_path(week_offset: params[:week_offset], grade: 1), class: (@grade == 1 ? "active" : "") %>
        <%= link_to "2年", timetables_path(week_offset: params[:week_offset], grade: 2), class: (@grade == 2 ? "active" : "") %>
      </div>

      <div class="grade-underline" style="transform: translateX(<%= @grade == 1 ? "0%" : "100%" %>);"></div>
    </header>

    <div class="schedule">
      <div class="controls">
        <span class="arrow left">
          <% if @week_offset > -1 %>
            <%= link_to "＜", timetables_path(week_offset: @week_offset - 1, grade: @grade) %>
          <% end %>
        </span>

        <% week_label =
            case @week_offset
            when -1 then "先週"
            when 0  then "今週"
            when 1  then "来週"
            end
        %>
        <span class="current-week"><%= week_label %></span>

        <span class="arrow right">
          <% if @week_offset < 1 %>
            <%= link_to "＞", timetables_path(week_offset: @week_offset + 1, grade: @grade) %>
          <% end %>
        </span>
      </div>

      <table class="timetable">
        <thead>
          <tr>
            <% (0..4).each do |i| %>
              <% date = @week_start + i.days %>
              <th><%= date.strftime("%-m月%-d日") %></th>
            <% end %>
          </tr>
          <tr>
            <% %w(月 火 水 木 金).each do |day| %>
              <th><%= day %></th>
            <% end %>
          </tr>
        </thead>

        <tbody>
          <% (1..3).each do |period| %>
            <tr>
              <% (1..5).each do |day| %>
                <% timetable = @timetables.find { |t| t.day_of_week == day && t.period == period } %>
                <% 
                  cell_class = []
                  cell_class << "changed-cell" if timetable && !timetable.base_subject
                  cell_class << "exam-cell" if timetable&.subject&.name&.start_with?("【試験】")
                %>
                <td class="<%= cell_class.join(' ') %>" data-day="<%= day %>" data-period="<%= period %>">
                  <%= timetable&.subject&.name&.gsub("【試験】", "") || "-" %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <footer class="timetable-footer">
      <div class="footer-left">
        <% if session[:role] == "teacher" %>
          <%= link_to "編集", "#", class: "footer-edit-btn", data: { grade: @grade, week_offset: @week_offset }  %>
          <%= link_to "デフォルトの時間割を変更", "#", class: "footer-default-btn", data: { grade: @grade } %>
        <% end %>
      </div>

      <div class="footer-right">
        <div class="theme-label" id="themeLabel">Lightmode</div>

        <input type="checkbox" id="themeSwitch" class="theme-switch__input" />
        <label for="themeSwitch" class="theme-switch__label">
          <span></span>
        </label>
      </div>

      <div class="footer-center">
        © 2025 Timetable App
      </div>
    </footer>

  </div>

  <!-- 編集用モーダル -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- 科目選択モーダル -->
  <div id="subject-modal" class="modal">
    <div class="modal-content subject-modal-content">
      <span class="close subject-close">&times;</span>
      <h3>科目を選択</h3>
      <div id="subject-modal-body"></div>
    </div>
  </div>

  <!-- お知らせ一覧モーダル -->
  <div id="announcements-modal" class="modal announcements-modal">
    <div class="modal-content">
      <span class="close announcements-close">&times;</span>
      <div id="announcements-modal-body"></div>
    </div>
  </div>

  <!-- お知らせ詳細モーダル -->
  <div id="announcement-detail-modal" class="modal announcement-detail-modal">
    <div class="modal-content">
      <span class="close announcement-detail-close">&times;</span>
      <div id="announcement-detail-body"></div>
    </div>
  </div>

  <!-- お知らせ作成モーダル -->
  <div id="create-announcement-modal" class="modal create-announcement-modal">
    <div class="modal-content">
      <span class="close create-announcement-close">&times;</span>
      <div id="create-announcement-body">
        <h2>お知らせを作成</h2>
        <form id="create-announcement-form">
          <div class="form-group">
            <label for="announcement-grade">対象学年</label>
            <select id="announcement-grade" required>
              <option value="1">1年生</option>
              <option value="2">2年生</option>
            </select>
          </div>
          <div class="form-group">
            <label for="announcement-title">タイトル</label>
            <input type="text" id="announcement-title" maxlength="100" required>
          </div>
          <div class="form-group">
            <label for="announcement-content">内容</label>
            <textarea id="announcement-content" maxlength="1000" required></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="cancel-btn" id="cancel-create-btn">キャンセル</button>
            <button type="submit" class="submit-btn">送信</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>

<script>
  const applyTheme = (isDark) => {
    const switchInput = document.getElementById("themeSwitch");
    const themeLabel = document.getElementById("themeLabel");

    if (!switchInput || !themeLabel) return;

    document.body.classList.toggle("dark-mode", isDark);
    switchInput.checked = isDark;
    themeLabel.textContent = isDark ? "Darkmode" : "Lightmode";
  };

  document.addEventListener("turbo:load", () => {
    const saved = localStorage.getItem("darkMode");
    applyTheme(saved === "1");
    
    // 未読件数を取得
    updateUnreadCount();
  });

  document.addEventListener("change", (e) => {
    if (e.target.id === "themeSwitch") {
      const isDark = e.target.checked;
      applyTheme(isDark);
      localStorage.setItem("darkMode", isDark ? "1" : "0");
    }
  });
  
  // 未読件数を更新
  function updateUnreadCount() {
    const grade = <%= @grade %>;
    fetch(`/announcements/unread_count?grade=${grade}`)
      .then(response => response.json())
      .then(data => {
        const badge = document.getElementById('unread-badge');
        if (data.unread_count > 0) {
          badge.textContent = data.unread_count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      })
      .catch(error => console.error('Error:', error));
  }
</script>